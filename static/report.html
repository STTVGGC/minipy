<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>ç•™è¨€æ¿é¡¹ç›®æŠ¥å‘Š</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #ffffff;
        color: #a0a0a0;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
    div.sourceCode
      { color: #1f1c1b; background-color: #ffffff; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #1f1c1b; } /* Normal */
    code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
    code span.an { color: #ca60ca; } /* Annotation */
    code span.at { color: #0057ae; } /* Attribute */
    code span.bn { color: #b08000; } /* BaseN */
    code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
    code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #924c9d; } /* Char */
    code span.cn { color: #aa5500; } /* Constant */
    code span.co { color: #898887; } /* Comment */
    code span.cv { color: #0095ff; } /* CommentVar */
    code span.do { color: #607880; } /* Documentation */
    code span.dt { color: #0057ae; } /* DataType */
    code span.dv { color: #b08000; } /* DecVal */
    code span.er { color: #bf0303; text-decoration: underline; } /* Error */
    code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
    code span.fl { color: #b08000; } /* Float */
    code span.fu { color: #644a9b; } /* Function */
    code span.im { color: #ff5500; } /* Import */
    code span.in { color: #b08000; } /* Information */
    code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
    code span.op { color: #1f1c1b; } /* Operator */
    code span.ot { color: #006e28; } /* Other */
    code span.pp { color: #006e28; } /* Preprocessor */
    code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #ff5500; } /* SpecialString */
    code span.st { color: #bf0303; } /* String */
    code span.va { color: #0057ae; } /* Variable */
    code span.vs { color: #bf0303; } /* VerbatimString */
    code span.wa { color: #bf0303; } /* Warning */
  </style>
  <link rel="stylesheet" href="obsidian.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">ç•™è¨€æ¿é¡¹ç›®æŠ¥å‘Š</h1>
</header>
<h1 id="é¡¹ç›®æŠ¥å‘Š-ç®€æ˜“ç•™è¨€æ¿minipy">é¡¹ç›®æŠ¥å‘Š â€” ç®€æ˜“ç•™è¨€æ¿ï¼ˆminipyï¼‰</h1>
<p>æ—¥æœŸï¼š2025-11-05</p>
<h2 id="é¡¹ç›®ç®€ä»‹ä¸åŠŸèƒ½æ¦‚è¿°">1 é¡¹ç›®ç®€ä»‹ä¸åŠŸèƒ½æ¦‚è¿°</h2>
<p>è¿™æ˜¯ä¸€ä¸ªåŸºäº FastAPI
çš„æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆJinja2ï¼‰ç¤ºä¾‹åº”ç”¨ï¼Œæä¾›ä¸€ä¸ªç®€æ˜“çš„ç•™è¨€æ¿åŠŸèƒ½ï¼Œä¸»è¦æ”¯æŒï¼š</p>
<ul>
<li>è®¿å®¢/ç”¨æˆ·å‘å¸ƒç•™è¨€ï¼ˆå¸¦å†…å®¹ä¸æ˜µç§°ï¼‰</li>
<li>ç•™è¨€çš„å›å¤ï¼ˆCommentï¼‰åŠŸèƒ½</li>
<li>ç‚¹èµï¼ˆlikesï¼‰ä¸åˆ é™¤ç•™è¨€/å›å¤</li>
<li>ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç™»å‡ºï¼ˆåŸºäº JWTï¼‰</li>
<li>å¯é€‰çš„ Redis ç¼“å­˜ç”¨äºåŠ é€ŸæŒ‰æœ€æ–°æ’åºçš„ç•™è¨€åˆ—è¡¨</li>
<li>ä½¿ç”¨ Tortoise ORM ç®¡ç†æ•°æ®åº“æ¨¡å‹ï¼Œå¹¶å¸¦æœ‰ aerich è¿ç§»æ”¯æŒ</li>
</ul>
<h2 id="ä½¿ç”¨çš„æŠ€æœ¯æ ˆ">2 ä½¿ç”¨çš„æŠ€æœ¯æ ˆ</h2>
<ul>
<li>Python 3.11ï¼ˆé•œåƒåŸºäº python:3.11-slimï¼‰</li>
<li>FastAPI â€” HTTP æ¡†æ¶ä¸è·¯ç”±</li>
<li>Uvicorn â€” ASGI è¿è¡Œå™¨</li>
<li>Jinja2 â€” åç«¯æ¨¡æ¿ï¼ˆä½äº <code>templates/</code>ï¼‰</li>
<li>Tortoise ORM â€” å¼‚æ­¥ ORMï¼ˆæ¨¡å‹å®šä¹‰åœ¨ <code>models.py</code>ï¼‰</li>
<li>aerich â€” Tortoise çš„è¿ç§»å·¥å…·ï¼ˆé…ç½®åœ¨
<code>pyproject.toml</code>ï¼‰</li>
<li>Redisï¼ˆå¯é€‰ï¼‰ â€” ç¼“å­˜å±‚ï¼ˆä½¿ç”¨ redis.asyncio å®¢æˆ·ç«¯ï¼‰</li>
<li>MySQLï¼ˆå¯é€‰ï¼‰/SQLite â€” æ•°æ®åº“åç«¯ï¼ˆ<code>tortoise_config.py</code>
æ”¯æŒé€šè¿‡ <code>DATABASE_URL</code> åˆ‡æ¢ï¼‰</li>
<li>passlibï¼ˆpbkdf2_sha256ï¼‰â€” å¯†ç å“ˆå¸Œ</li>
<li>python-jose â€” JWT ç¼–ç ä¸è§£ç </li>
<li>å…¶ä»–ï¼špython-multipartã€aiomysqlã€jinja2</li>
</ul>
<p>ä¾èµ–æ¸…å•è§ <code>requirements.txt</code>ã€‚</p>
<h2 id="æ ¸å¿ƒå®ç°é€»è¾‘">3 æ ¸å¿ƒå®ç°é€»è¾‘</h2>
<p>ä»¥ä¸‹åˆ—å‡ºæœ¬é¡¹ç›®çš„ä¸»è¦å®ç°è¦ç‚¹ã€æ•°æ®æµä¸æ³¨æ„äº‹é¡¹ã€‚</p>
<h3 id="å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸlifespan">3.1 å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸï¼ˆLifespanï¼‰</h3>
<p>æˆ‘ä»¬çš„é¡¹ç›®åœ¨å¯åŠ¨å’Œå…³é—­æ—¶éœ€è¦æ­£ç¡®å¤„ç†æ•°æ®åº“å’Œç¼“å­˜è¿æ¥ã€‚<br />
ä¸ºäº†é¿å…èµ„æºæœªé‡Šæ”¾æˆ–å¯åŠ¨å¤±è´¥ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† <strong>FastAPI çš„
lifespan</strong>ã€‚<br />
å®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶ç»Ÿä¸€å»ºç«‹è¿æ¥ï¼Œåœ¨é€€å‡ºæ—¶è‡ªåŠ¨å…³é—­ï¼Œä¿è¯äº†æœåŠ¡åœ¨å®¹å™¨åŒ–æˆ–éƒ¨ç½²ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œã€‚</p>
<h4 id="ä»€ä¹ˆæ˜¯-lifespan">ä»€ä¹ˆæ˜¯ Lifespan</h4>
<p><code>lifespan</code> æ˜¯ FastAPI æä¾›çš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚<br />
ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š</p>
<blockquote>
<p>â€œç¨‹åºå¯åŠ¨å‰åšå‡†å¤‡å·¥ä½œï¼Œç¨‹åºé€€å‡ºå‰åšæ¸…ç†ã€‚â€</p>
</blockquote>
<p>æˆ‘ä»¬ä½¿ç”¨ Python çš„ <code>asynccontextmanager</code>
æ¥å®šä¹‰è¿™æ®µç”Ÿå‘½å‘¨æœŸé€»è¾‘ã€‚</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">@asynccontextmanager</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> lifespan(app: FastAPI):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¯åŠ¨é˜¶æ®µ</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> Tortoise.init(db_url<span class="op">=</span>DATABASE_URL, modules<span class="op">=</span>{<span class="st">&quot;models&quot;</span>: [<span class="st">&quot;models&quot;</span>]})</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> GENERATE_SCHEMAS:</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> Tortoise.generate_schemas()</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åˆå§‹åŒ– Redis</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        redis <span class="op">=</span> Redis(host<span class="op">=</span>REDIS_HOST, port<span class="op">=</span>REDIS_PORT, db<span class="op">=</span>REDIS_DB, decode_responses<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> redis.ping()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        redis_available <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        redis_available <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        redis <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># åº”ç”¨è¿è¡Œä¸­</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># å…³é—­æ•°æ®åº“ä¸ç¼“å­˜</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> Tortoise.close_connections()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> redis <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>            close_fn <span class="op">=</span> <span class="bu">getattr</span>(redis, <span class="st">&quot;close&quot;</span>, <span class="va">None</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> inspect.isawaitable(close_fn()):</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> close_fn()</span></code></pre></div>
<h4 id="lifespan-çš„å¥½å¤„">Lifespan çš„å¥½å¤„</h4>
<p>ç›¸æ¯”åœ¨æ¨¡å—å¯¼å…¥æ—¶å°±è¿æ¥å¤–éƒ¨æœåŠ¡ï¼Œä½¿ç”¨ lifespan å¯ä»¥ï¼š</p>
<ul>
<li>âœ… å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆåªæœ‰ç¨‹åºå¯åŠ¨æ—¶è¿æ¥ï¼‰<br />
</li>
<li>âœ… é›†ä¸­ç®¡ç†èµ„æºï¼ˆå¯åŠ¨åˆ›å»ºã€é€€å‡ºé‡Šæ”¾ï¼‰<br />
</li>
<li>âœ… æå‡å®¹å™¨åŒ–ç¨³å®šæ€§ä¸å®‰å…¨æ€§</li>
</ul>
<h3 id="å¯†ç å¤„ç†ä¸è®¤è¯password-authentication">3.2
å¯†ç å¤„ç†ä¸è®¤è¯ï¼ˆPassword &amp; Authenticationï¼‰</h3>
<h4 id="ä¸€å¯†ç åŠ å¯†ä¸éªŒè¯">ä¸€ã€å¯†ç åŠ å¯†ä¸éªŒè¯</h4>
<p>ç”¨æˆ·å¯†ç ä¸ä¼šç›´æ¥ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ <strong>Passlib</strong>
åº“çš„ <code>pbkdf2_sha256</code> ç®—æ³•è¿›è¡Œå“ˆå¸ŒåŠ å¯†ã€‚</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_password_hash(password):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æˆªæ–­åˆ°72å­—èŠ‚ä»¥å…¼å®¹æ—§ç‰ˆbcrypt</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    password_bytes <span class="op">=</span> password.encode(<span class="st">&#39;utf-8&#39;</span>)[:<span class="dv">72</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    truncated <span class="op">=</span> password_bytes.decode(<span class="st">&#39;utf-8&#39;</span>, errors<span class="op">=</span><span class="st">&#39;replace&#39;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pwd_context.<span class="bu">hash</span>(truncated)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> verify_password(plain_password, hashed_password):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    password_bytes <span class="op">=</span> plain_password.encode(<span class="st">&#39;utf-8&#39;</span>)[:<span class="dv">72</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    truncated <span class="op">=</span> password_bytes.decode(<span class="st">&#39;utf-8&#39;</span>, errors<span class="op">=</span><span class="st">&#39;replace&#39;</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pwd_context.verify(truncated, hashed_password)</span></code></pre></div>
<blockquote>
<p>é¡¹ç›®ä¸­ä¿ç•™äº†æˆªæ–­é€»è¾‘ï¼Œç¡®ä¿ä¸å†å²å“ˆå¸Œè¡Œä¸ºå…¼å®¹ï¼Œé˜²æ­¢è€ç”¨æˆ·ç™»å½•å¤±è´¥ã€‚</p>
</blockquote>
<h4 id="äºŒjwt-ç™»å½•è®¤è¯">äºŒã€JWT ç™»å½•è®¤è¯</h4>
<p>ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä½¿ç”¨ <strong>JWTï¼ˆJSON Web Tokenï¼‰</strong>
ç”Ÿæˆä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚<br />
ä»¤ç‰Œä¸­åŒ…å«ç”¨æˆ·ä¿¡æ¯ä¸è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 30 åˆ†é’Ÿï¼‰ã€‚</p>
<p>ç”Ÿæˆæ–¹å¼ï¼š</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>SECRET_KEY <span class="op">=</span> <span class="st">&quot;your_secret&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ALGORITHM <span class="op">=</span> <span class="st">&quot;HS256&quot;</span></span></code></pre></div>
<p>å‘ç»™å®¢æˆ·ç«¯æ—¶å­˜å…¥ Cookieï¼š</p>
<pre><code>access_token = Bearer &lt;token&gt;</code></pre>
<p>Cookie å±æ€§ï¼š</p>
<ul>
<li><code>httponly</code>: é˜²æ­¢ JS è¯»å–ï¼ˆé˜² XSSï¼‰</li>
<li><code>samesite=lax</code>: é˜²è·¨ç«™æ”»å‡»</li>
</ul>
<blockquote>
<p>âœ… â€œæˆ‘ä»¬ç”¨ JWT é€šè¡Œè¯è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œä¸ä¿å­˜å¯†ç ï¼ŒåªéªŒè¯ä»¤ç‰Œã€‚â€</p>
</blockquote>
<h3 id="ç¼“å­˜ç­–ç•¥caching-strategy">3.3 ç¼“å­˜ç­–ç•¥ï¼ˆCaching Strategyï¼‰</h3>
<p>ç•™è¨€åˆ—è¡¨æ”¯æŒç¼“å­˜ï¼Œä»¥åŠ é€ŸåŠ è½½â€œæœ€æ–°ç•™è¨€â€æ—¶çš„å“åº”é€Ÿåº¦ã€‚</p>
<h4 id="ç¼“å­˜å·¥ä½œæµç¨‹">ç¼“å­˜å·¥ä½œæµç¨‹</h4>
<ol type="1">
<li><p>ç”¨æˆ·æ‰“å¼€ç•™è¨€ä¸»é¡µæ—¶ï¼Œåå°ä¼˜å…ˆå°è¯•ä» Redis è·å–ç¼“å­˜æ•°æ®ï¼š</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cache_get(CACHE_KEY_MESSAGES)</span></code></pre></div>
<ul>
<li>å‘½ä¸­ç¼“å­˜ï¼šç›´æ¥è¿”å›ï¼ŒåŠ è½½é€Ÿåº¦å¿«ï¼›</li>
<li>æœªå‘½ä¸­ï¼šä»æ•°æ®åº“æŸ¥è¯¢å¹¶å†™å…¥ç¼“å­˜ã€‚</li>
</ul></li>
<li><p>å½“ç•™è¨€è¢«æ–°å¢ã€ç‚¹èµæˆ–åˆ é™¤æ—¶ï¼š</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> cache_delete(CACHE_KEY_MESSAGES)</span></code></pre></div>
<p>åˆ é™¤æ—§ç¼“å­˜ï¼Œä¿è¯é¡µé¢æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚</p></li>
<li><p>è‹¥ Redis è¿æ¥å¤±è´¥ï¼Œåˆ™è‡ªåŠ¨å…³é—­ç¼“å­˜åŠŸèƒ½ï¼š</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>redis_available <span class="op">=</span> <span class="va">False</span></span></code></pre></div>
<p>ä¹‹åç›´æ¥è¯»æ•°æ®åº“ï¼Œä¸å½±å“ä¸»æµç¨‹ã€‚</p></li>
</ol>
<blockquote>
<p>å³ä¾¿ Redis å´©æºƒï¼Œç¨‹åºä»ç„¶èƒ½æ­£å¸¸å·¥ä½œï¼ˆé™çº§æœºåˆ¶ï¼‰ã€‚</p>
</blockquote>
<h4 id="ç¤ºä¾‹ä»£ç å¼‚å¸¸ä¿æŠ¤">ç¤ºä¾‹ä»£ç ï¼ˆå¼‚å¸¸ä¿æŠ¤ï¼‰</h4>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> cache_get(key: <span class="bu">str</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> redis_available <span class="kw">or</span> redis <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> redis.get(key)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        redis_available <span class="op">=</span> <span class="va">False</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
<h3 id="æ•°æ®æ¨¡å‹database-models">3.4 æ•°æ®æ¨¡å‹ï¼ˆDatabase Modelsï¼‰</h3>
<p>æœ¬é¡¹ç›®åŒ…å«ä¸‰å¼ ä¸»è¦æ•°æ®è¡¨ï¼šç•™è¨€ã€è¯„è®ºã€ç”¨æˆ·ã€‚<br />
å‡ç”± <strong>Tortoise ORM</strong> å®šä¹‰åœ¨ <code>models.py</code>
ä¸­ã€‚</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>åŠŸèƒ½</th>
<th>ä¸»è¦å­—æ®µ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Message</strong></td>
<td>å­˜æ”¾ç•™è¨€</td>
<td>id, name, user(FK), content, likes, created_at</td>
</tr>
<tr>
<td><strong>Comment</strong></td>
<td>å­˜æ”¾å›å¤</td>
<td>id, message(FK), name, user(FK), content, created_at</td>
</tr>
<tr>
<td><strong>User</strong></td>
<td>å­˜æ”¾ç”¨æˆ·</td>
<td>id, username(unique), password_hash, is_active, created_at</td>
</tr>
</tbody>
</table>
<p>è¡¨åé€šè¿‡ <code>Meta.table</code> æ˜¾å¼å®šä¹‰ï¼ˆå¦‚ <code>messages</code>,
<code>comments</code>,
<code>users</code>ï¼‰ï¼Œä¾¿äºåæœŸè¿ç§»æˆ–æ•°æ®åº“å…¼å®¹ã€‚</p>
<h3 id="è·¯ç”±ä¸è§†å›¾main.py">3.5 è·¯ç”±ä¸è§†å›¾ï¼ˆmain.pyï¼‰</h3>
<h4 id="è·¯ç”±åŠŸèƒ½æ¦‚è§ˆ">è·¯ç”±åŠŸèƒ½æ¦‚è§ˆ</h4>
<table>
<thead>
<tr>
<th>è·¯å¾„</th>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/</code></td>
<td>GET</td>
<td>ç•™è¨€ä¸»é¡µï¼ˆæ”¯æŒæ’åºã€è¯»å–ç¼“å­˜ï¼‰</td>
</tr>
<tr>
<td><code>/submit</code></td>
<td>POST</td>
<td>æäº¤ç•™è¨€</td>
</tr>
<tr>
<td><code>/like/{msg_id}</code></td>
<td>GET</td>
<td>ç‚¹èµç•™è¨€</td>
</tr>
<tr>
<td><code>/comment/{msg_id}</code></td>
<td>POST</td>
<td>æ·»åŠ å›å¤</td>
</tr>
<tr>
<td><code>/comments/{msg_id}</code></td>
<td>GET</td>
<td>è·å–æŸæ¡ç•™è¨€çš„æ‰€æœ‰è¯„è®º</td>
</tr>
<tr>
<td><code>/register</code>, <code>/login</code>,
<code>/logout</code></td>
<td>POST/GET</td>
<td>ç”¨æˆ·ç›¸å…³åŠŸèƒ½</td>
</tr>
</tbody>
</table>
<p>é¡µé¢ä½¿ç”¨ <strong>Jinja2 æ¨¡æ¿</strong> æ¸²æŸ“ï¼Œéƒ¨åˆ†äº¤äº’é‡‡ç”¨ <strong>AJAX
å¼‚æ­¥æäº¤</strong>ã€‚</p>
<h4 id="æäº¤ç•™è¨€ç¤ºä¾‹">æäº¤ç•™è¨€ç¤ºä¾‹</h4>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">&quot;/submit&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> submit_message(request: Request, name: <span class="bu">str</span> <span class="op">=</span> Form(<span class="va">None</span>), content: <span class="bu">str</span> <span class="op">=</span> Form(...)):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> content.strip():</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> RedirectResponse(<span class="st">&quot;/&quot;</span>, status_code<span class="op">=</span><span class="dv">303</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_user:</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> Message.create(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>current_user.username,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>current_user,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            content<span class="op">=</span>content.strip(),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            created_at<span class="op">=</span>datetime.now()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> name.strip():</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> RedirectResponse(<span class="st">&quot;/&quot;</span>, status_code<span class="op">=</span><span class="dv">303</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> Message.create(</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>name.strip(),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            content<span class="op">=</span>content.strip(),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            created_at<span class="op">=</span>datetime.now()</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> cache_delete(CACHE_KEY_MESSAGES)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RedirectResponse(<span class="st">&quot;/&quot;</span>, status_code<span class="op">=</span><span class="dv">303</span>)</span></code></pre></div>
<p>ğŸ—’ï¸ å†™æ“ä½œåç«‹å³æ¸…é™¤ç¼“å­˜ï¼Œé˜²æ­¢è¯»å–æ—§æ•°æ®ã€‚</p>
<h2 id="é¡¹ç›®è¿è¡Œè¯´æ˜">4 é¡¹ç›®è¿è¡Œè¯´æ˜</h2>
<h3 id="æœ¬åœ°è¿è¡Œpowershell">4.1 æœ¬åœ°è¿è¡Œï¼ˆPowerShellï¼‰</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>python <span class="op">-</span>m venv <span class="op">.</span><span class="fu">venv</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>\<span class="op">.</span><span class="fu">venv</span>\Scripts\Activate<span class="op">.</span><span class="fu">ps1</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>pip install <span class="op">-</span>r requirements<span class="op">.</span><span class="fu">txt</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>uvicorn main<span class="op">:</span>app <span class="op">--</span>reload <span class="op">--</span>host <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span> <span class="op">--</span>port <span class="dv">8000</span></span></code></pre></div>
<p>è®¿é—®ï¼š - é¦–é¡µï¼š<a
href="http://localhost:8000">http://localhost:8000</a> - API æ–‡æ¡£ï¼š<a
href="http://localhost:8000/docs">http://localhost:8000/docs</a></p>
<blockquote>
<p>âš ï¸ è¯·ç¡®ä¿ <code>DATABASE_URL</code>
åœ¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ä¸­å·²æ­£ç¡®è®¾ç½®ã€‚</p>
</blockquote>
<h3 id="docker-è¿è¡Œ">4.2 Docker è¿è¡Œ</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>docker-compose up <span class="op">--</span>build <span class="op">-</span>d</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>docker-compose logs <span class="op">-</span>f</span></code></pre></div>
<p><code>docker-compose.yml</code> åŒ…å« <code>app</code>,
<code>db</code>, <code>redis</code> ä¸‰ä¸ªæœåŠ¡ã€‚<br />
å¦‚éœ€è‡ªåŠ¨åˆ›å»ºè¡¨ï¼Œè¯·åœ¨ç¯å¢ƒå˜é‡ä¸­å¯ç”¨ï¼š</p>
<pre><code>GENERATE_SCHEMAS=True
DATABASE_URL=mysql://appuser:secret@db:3306/messageboard</code></pre>
<h2 id="ç»“è¯­">5 ç»“è¯­</h2>
<p>æœ¬ç•™è¨€æ¿é¡¹ç›®æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¼‚æ­¥ Web åº”ç”¨ç¤ºä¾‹ï¼Œç»“åˆäº†
<strong>FastAPI</strong> çš„é«˜æ€§èƒ½ã€<strong>Tortoise ORM</strong>
çš„æ˜“ç”¨æ€§ä¸ <strong>Redis ç¼“å­˜</strong> çš„é«˜æ•ˆç‰¹æ€§ã€‚</p>
<p><strong>é¡¹ç›®äº®ç‚¹ï¼š</strong> - æ¨¡å—ç»“æ„æ¸…æ™°ã€ä»£ç æ˜“è¯»ï¼› -
å…·å¤‡å®Œæ•´çš„ç”¨æˆ·è®¤è¯ä¸ç•™è¨€é€»è¾‘ï¼› - ä½¿ç”¨ Redis ç¼“å­˜åŠ é€Ÿé¡µé¢ï¼› - æ”¯æŒ Docker
ä¸€é”®éƒ¨ç½²ã€‚</p>
<h3 id="é¡¹ç›®ä¿¡æ¯">é¡¹ç›®ä¿¡æ¯</h3>
<ul>
<li>å·²éƒ¨ç½²åœ°å€ï¼š <a href="https://wzh730903.top"
class="uri">https://wzh730903.top</a></li>
<li>GitHubï¼š <a href="https://github.com/STTVGGC/minipy"
class="uri">https://github.com/STTVGGC/minipy</a></li>
<li>Docker Hubï¼š sttvggc/messageboard</li>
</ul>
</body>
</html>
