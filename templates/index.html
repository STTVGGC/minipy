<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç®€æ˜“ç•™è¨€æ¿</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .msg { border-bottom: 1px solid #ddd; padding: 8px; margin-bottom: 10px; }
        .meta { font-size: 0.9em; color: #555; display: flex; justify-content: space-between; }
        .delete-btn {
            background-color: #ff6666;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .like-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin-right: 10px;
        }
        .like-btn:hover {
            background-color: #e0e0e0;
        }
        .like-btn.liked {
            background-color: #ffebee;
            color: #e53935;
            border-color: #ffcdd2;
        }
        .like-count {
            margin-left: 4px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .reply-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .reply-btn:hover {
            background-color: #e0e0e0;
        }
        .sort-links a {
            margin-right: 10px;
            text-decoration: none;
            color: #0078d4;
        }
        .sort-links a.active { font-weight: bold; color: #000; }
        .comments {
            margin-top: 10px;
            padding-left: 20px;
            border-left: 3px solid #eee;
        }
        .comment {
            padding: 5px 0;
            font-size: 0.9em;
            color: #333;
        }
        .comment-meta {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 2px;
        }
        .delete-comment-btn {
            background-color: #ff9e9e;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            cursor: pointer;
            margin-left: 5px;
        }
        .reply-form {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            display: none;
        }
        .reply-form input,
        .reply-form textarea {
            width: 100%;
            padding: 5px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .reply-form textarea {
            height: 60px;
            resize: vertical;
        }
        .reply-form button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .reply-form button:hover {
            background-color: #45a049;
        }
        .cancel-reply {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“œ ç®€æ˜“ç•™è¨€æ¿</h1>
    
    <div class="user-status">
        {% if current_user %}
            <span>æ¬¢è¿ï¼Œ{{ current_user.username }}ï¼</span>
            <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
        {% else %}
            <a href="/login" class="login-btn">ç™»å½•</a>
            <a href="/register" class="register-btn">æ³¨å†Œ</a>
        {% endif %}
    </div>

    <form action="/submit" method="post">
        {% if current_user %}
            <input type="text" name="name" value="{{ current_user.username }}" readonly>
        {% else %}
            <input type="text" name="name" placeholder="ä½ çš„åå­—" required>
        {% endif %}
        <textarea name="content" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..." required></textarea>
        <button type="submit">æäº¤ç•™è¨€</button>
    </form>
    
    <style>
        .user-status {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            gap: 10px;
        }
        .login-btn, .register-btn, .logout-btn {
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9em;
        }
        .login-btn {
            background-color: #007bff;
            color: white;
        }
        .register-btn {
            background-color: #28a745;
            color: white;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
        }
        input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
    </style>

    <div class="sort-links">
        æ’åºæ–¹å¼ï¼š
        <a href="/?sort=desc" class="{% if sort == 'desc' %}active{% endif %}">æœ€æ–°ä¼˜å…ˆ</a>
        <a href="/?sort=asc" class="{% if sort == 'asc' %}active{% endif %}">æœ€æ—©ä¼˜å…ˆ</a>
    </div>

    <div class="messages">
        {% for msg in messages %}
        <div class="msg" data-msg-id="{{ msg.id }}">
            <div class="meta">
                <span>ğŸ—“ {{ msg.created_at }} | ğŸ‘¤ {{ msg.name }}</span>
                <a href="/delete/{{ msg.id }}"><button class="delete-btn">åˆ é™¤</button></a>
            </div>
            <div class="content">{{ msg.content }}</div>
            <div class="action-buttons">
                <button class="like-btn" onclick="likeMessage({{ msg.id|tojson }})"><span>ğŸ‘</span> <span class="like-count">{{ msg.likes }}</span></button>
                <button class="reply-btn" onclick="toggleReplyForm({{ msg.id|tojson }})"><span>ğŸ’¬</span> å›å¤</button>
            </div>
            
            <!-- å›å¤è¡¨å• -->
            <div class="reply-form" id="reply-form-{{ msg.id }}">
                {% if current_user %}
                    <input type="text" id="reply-name-{{ msg.id }}" value="{{ current_user.username }}" readonly required>
                {% else %}
                    <input type="text" id="reply-name-{{ msg.id }}" placeholder="ä½ çš„åå­—" required>
                {% endif %}
                <textarea id="reply-content-{{ msg.id }}" placeholder="å†™ä¸‹ä½ çš„å›å¤..." required></textarea>
                <button onclick="submitReply({{ msg.id|tojson }})">æäº¤å›å¤</button>
                <button class="cancel-reply" onclick="toggleReplyForm({{ msg.id|tojson }})">å–æ¶ˆ</button>
              </div>
            
            <!-- è¯„è®ºåŒºåŸŸ -->
            <div class="comments" id="comments-{{ msg.id }}">
                <!-- è¯„è®ºå°†é€šè¿‡AJAXåŠ¨æ€åŠ è½½ -->
                <div class="loading-comments">åŠ è½½è¯„è®ºä¸­...</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <a class="clear" href="/clear">æ¸…ç©ºæ‰€æœ‰ç•™è¨€</a>
</div>
    <script>
        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ‰€æœ‰è¯„è®º
        document.addEventListener('DOMContentLoaded', function() {
            const messages = document.querySelectorAll('.msg');
            messages.forEach(msg => {
                const msgId = msg.getAttribute('data-msg-id');
                loadComments(msgId);
            });
        });

        // ç‚¹èµåŠŸèƒ½
        function likeMessage(msgId) {
            const likeBtn = document.querySelector(`.msg[data-msg-id="${msgId}"] .like-btn`);
            const likeCount = document.querySelector(`.msg[data-msg-id="${msgId}"] .like-count`);
            
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            likeBtn.disabled = true;
            
            fetch(`/like/${msgId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        likeCount.textContent = data.likes;
                        likeBtn.classList.add('liked');
                        
                        // æ·»åŠ ç‚¹èµåŠ¨ç”»æ•ˆæœ
                        likeBtn.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            likeBtn.style.transform = 'scale(1)';
                        }, 200);
                    }
                    likeBtn.disabled = false;
                })
                .catch(error => {
                    console.error('ç‚¹èµå¤±è´¥:', error);
                    likeBtn.disabled = false;
                });
        }

        // åˆ‡æ¢å›å¤è¡¨å•æ˜¾ç¤º
        function toggleReplyForm(msgId) {
            const replyForm = document.getElementById(`reply-form-${msgId}`);
            replyForm.style.display = replyForm.style.display === 'block' ? 'none' : 'block';
        }

        // æäº¤å›å¤
        function submitReply(msgId) {
            const nameInput = document.getElementById(`reply-name-${msgId}`);
            const contentInput = document.getElementById(`reply-content-${msgId}`);
            const commentsContainer = document.getElementById(`comments-${msgId}`);
            
            const name = nameInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!name || !content) {
                alert('è¯·å¡«å†™åå­—å’Œå›å¤å†…å®¹');
                return;
            }
            
            const formData = new FormData();
            formData.append('name', name);
            formData.append('content', content);
            formData.append('msg_id', msgId);
            
            fetch(`/comment/${msgId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // é‡ç½®è¡¨å•
                    nameInput.value = '';
                    contentInput.value = '';
                    
                    // éšè—å›å¤è¡¨å•
                    toggleReplyForm(msgId);
                    
                    // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                    loadComments(msgId);
                } else {
                    alert('æäº¤å›å¤å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('æäº¤å›å¤å¤±è´¥:', error);
                alert('æäº¤å›å¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            });
        }

        // åŠ è½½è¯„è®ºåˆ—è¡¨
        function loadComments(msgId) {
            const commentsContainer = document.getElementById(`comments-${msgId}`);
            
            fetch(`/comments/${msgId}`)
                .then(response => response.json())
                .then(data => {
                    // åªæœ‰åœ¨æ”¶åˆ°æœåŠ¡å™¨å“åº”åæ‰æ¸…ç©ºå¹¶æ›´æ–°è¯„è®ºå®¹å™¨
                    commentsContainer.innerHTML = '';
                    
                    if (data.comments && data.comments.length > 0) {
                        data.comments.forEach(comment => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment';
                            commentEl.innerHTML = `
                                <div class="comment-meta">
                                    ğŸ‘¤ ${comment.name} | â° ${comment.time_display}
                                    <button class="delete-comment-btn" onclick="deleteComment(${comment.id}, ${msgId}, event)"><span>ğŸ—‘ï¸</span></button>
                                </div>
                                <div class="comment-content">${comment.content}</div>
                            `;
                            commentsContainer.appendChild(commentEl);
                        });
                    } else {
                        commentsContainer.innerHTML = '<div class="no-comments">æš‚æ— å›å¤ï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</div>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                    commentsContainer.innerHTML = '<div class="error-comments">åŠ è½½è¯„è®ºå¤±è´¥</div>';
                });
        }

        // åˆ é™¤è¯„è®º
        function deleteComment(commentId, msgId, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘çˆ¶å…ƒç´ çš„äº‹ä»¶
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // åªæœ‰å½“ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æ—¶æ‰æ‰§è¡Œåˆ é™¤æ“ä½œ
            const userConfirmed = confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¤å—ï¼Ÿ');
            if (userConfirmed) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const commentsContainer = document.getElementById(`comments-${msgId}`);
                const originalContent = commentsContainer.innerHTML; // ä¿å­˜å½“å‰å†…å®¹
                
                fetch(`/delete-comment/${commentId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // åªæœ‰åœ¨ç¡®è®¤åˆ é™¤æˆåŠŸåæ‰é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                            loadComments(msgId);
                        } else {
                            alert('åˆ é™¤å›å¤å¤±è´¥: ' + data.error);
                            // åˆ é™¤å¤±è´¥æ—¶ä¿æŒåŸæœ‰å†…å®¹ä¸å˜
                        }
                    })
                    .catch(error => {
                        console.error('åˆ é™¤å›å¤å¤±è´¥:', error);
                        alert('åˆ é™¤å›å¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                        // å‡ºé”™æ—¶ä¿æŒåŸæœ‰å†…å®¹ä¸å˜
                    });
            }
            // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        }
    </script>
</body>
</html>
